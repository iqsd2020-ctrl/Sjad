<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>MASTER KEY - باحث الريموت</title>
    
    <!-- [جديد] ميتا تاغ خاصة بالتطبيق -->
    <meta name="theme-color" content="#FFD700">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="apple-mobile-web-app-title" content="MASTER KEY">
    
    <!-- [إزالة] تم حذف رابط ملف Manifest -->

    <!-- تحميل Tailwind CSS --><script src="https://cdn.tailwindcss.com"></script>
    
    <!-- خط Cairo (خط عربي حديث وجميل) مع خط Lato للأرقام والأجزاء الإنجليزية --><link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Cairo:wght@400;600;700&family=Lato:wght@400;700&display=swap" rel="stylesheet">

    <!-- CSS مخصص للتصميم العصري --><style>
        :root {
            --primary-color: #FFD700; /* ذهبي أساسي */
            --secondary-color: #ffc300; /* ذهبي ثانوي (للتأثيرات) */
            --text-color: #e2e8f0; /* أبيض رمادي للنصوص */
            --bg-dark: #1a202c; /* خلفية داكنة جداً */
            --bg-light: #2d3748; /* خلفية فاتحة قليلاً للعناصر */
            --border-color: #FFD700; /* لون الإطار الذهبي (طلب المستخدم) */
            --highlight-color: #ffc300; /* لون للتركيز والتأكيد */
            --success-color: #10b981; /* أخضر للنجاح */
            --error-color: #ef4444; /* أحمر للخطأ */
            --info-color: #3b82f6; /* أزرق للمعلومات */
            --success-feedback: #22c55e; /* أخضر ساطع لعلامة الصح */
        }

        body {
            font-family: 'Cairo', sans-serif;
            background-color: var(--bg-dark);
            color: var(--text-color);
            /* [تعديل] السماح بالتمرير الآن بعد إزالة القفل */
            overflow: auto;
        }
        
        .latin-font {
            font-family: 'Lato', sans-serif;
        }
        
        .text-gold {
            color: var(--primary-color);
        }

        .card-container {
            background-color: var(--bg-light);
            border-radius: 1rem;
            box-shadow: 0 10px 25px rgba(0, 0, 0, 0.3);
            border: 1px solid var(--border-color);
        }

        .app-input {
            background-color: var(--bg-dark);
            border: 1px solid var(--border-color);
            color: var(--text-color);
            border-radius: 0.5rem;
            transition: all 0.2s ease-in-out;
        }
        
        .app-input::placeholder {
            color: #a0aec0;
        }

        .app-input:focus {
            outline: none;
            border-color: var(--highlight-color);
            box-shadow: 0 0 0 2px rgba(255, 215, 0, 0.4);
        }
        
        .app-input option {
            background-color: var(--bg-dark);
            color: var(--text-color);
        }
        
        /* --- أنماط قائمة الاقتراحات (Autocomplete) --- */
        .autocomplete-suggestions {
            position: absolute;
            top: 100%;
            left: 0;
            right: 0;
            background-color: var(--bg-dark);
            border: 1px solid var(--border-color);
            border-top: none;
            max-height: 200px;
            overflow-y: auto;
            z-index: 10;
            display: none;
            border-radius: 0 0 0.5rem 0.5rem;
        }
        .suggestion-item {
            padding: 0.75rem 1rem;
            cursor: pointer;
            color: var(--text-color);
            transition: background-color 0.2s ease;
        }
        .suggestion-item:hover {
            background-color: #222c3d;
        }

        /* الزر الرئيسي */
        .app-button {
            background-color: var(--primary-color);
            color: var(--bg-dark);
            font-weight: 600;
            border-radius: 0.5rem;
            transition: background-color 0.2s ease-in-out, box-shadow 0.2s ease-in-out;
            box-shadow: 0 4px 10px rgba(255, 215, 0, 0.3);
            position: relative;
            overflow: hidden;
            min-height: 48px;
        }

        .app-button:hover {
            background-color: var(--secondary-color);
            box-shadow: 0 6px 15px rgba(255, 215, 0, 0.4);
        }
        
        /* زر المسح */
        .clear-button {
            background-color: transparent;
            color: #cbd5e0;
            border: 1px solid var(--border-color);
            font-weight: 400;
            border-radius: 0.5rem;
            transition: all 0.2s ease-in-out;
            min-height: 48px;
        }
        .clear-button:hover {
            background-color: rgba(255, 255, 255, 0.1);
            color: #ffffff;
            border-color: var(--highlight-color);
        }

        /* --- مؤشر التحميل --- */
        .loader {
            width: 24px;
            height: 24px;
            border: 4px solid var(--bg-dark);
            border-top-color: transparent;
            border-radius: 50%;
            animation: spin 1s linear infinite;
        }
        .loader.hidden {
            display: none;
        }
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        
        /* --- أنماط التبويبات --- */
        .tab-btn {
            padding: 0.75rem 1rem;
            cursor: pointer;
            border-bottom: 3px solid transparent;
            color: #a0aec0;
            transition: all 0.2s ease;
            font-size: 0.875rem;
            text-align: center;
            flex-grow: 1;
        }
        .tab-btn:hover {
            color: #e2e8f0;
        }
        .tab-btn.active {
            color: var(--primary-color);
            border-bottom-color: var(--primary-color);
            font-weight: 600;
        }
        .search-panel {
            display: none;
            animation: fadeIn 0.3s ease-in-out;
        }
        .search-panel.active {
            display: block;
        }
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }

        /* --- تنسيق الأكورديون (النتائج) --- */
        .accordion-header {
            cursor: pointer;
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 1rem;
            background-color: var(--bg-dark);
            border: 1px solid var(--border-color);
            border-radius: 0.5rem;
            margin-bottom: 0.5rem;
            transition: background-color 0.2s ease;
        }
        .accordion-header:hover {
            background-color: #222c3d;
        }
        .accordion-icon {
            transition: transform 0.3s ease;
        }
        .accordion-header.active .accordion-icon {
            transform: rotate(180deg);
        }
        .accordion-content {
            max-height: 0;
            overflow: hidden;
            transition: max-height 0.4s ease-out, padding 0.4s ease-out;
            padding: 0 1rem;
            background-color: var(--bg-dark);
            border-radius: 0.5rem;
            margin-bottom: 0.5rem;
        }
        .accordion-content.active {
            max-height: 800px;
            padding-top: 1rem;
            padding-bottom: 1rem;
        }
        .accordion-content .border-gray-700 {
            border-color: var(--border-color);
        }

        /* --- أزرار إجراءات الأكورديون (حفظ ومشاركة) --- */
        .accordion-actions {
            display: flex;
            align-items: center;
            gap: 0.75rem; /* 12px */
            margin-left: 1rem; /* RTL: left */
        }
        .action-btn {
            cursor: pointer;
            color: #9ca3af; /* gray-400 */
            transition: all 0.2s ease;
        }
        .action-btn:hover {
            color: #ffffff;
        }
        .action-btn.saved {
            color: var(--primary-color) !important; /* لون ذهبي للنجمة المحفوظة */
        }

        /* --- تنسيق جداول النتائج --- */
        .results-table {
            width: 100%;
            border-collapse: collapse;
        }
        .results-table td, .results-table th {
            padding: 0.75rem 0.5rem;
            text-align: right;
            border-bottom: 1px solid #4a5568;
        }
        .results-table th {
            color: var(--primary-color);
            font-weight: 600;
            background-color: #2d3748;
        }
        .results-table tr:last-child td {
            border-bottom: none;
        }
        
        /* --- تنسيق بطاقات البدائل --- */
        .alternative-card {
            background-color: #222c3d;
            border: 1px solid var(--border-color);
            border-radius: 0.75rem;
            padding: 1rem;
        }
        .scrollable-card-container {
            max-height: 300px;
            overflow-y: auto;
            padding-left: 0.5rem;
        }

        /* --- أيقونة النسخ --- */
        .copy-btn {
            cursor: pointer;
            opacity: 0.6;
            transition: all 0.2s ease;
            margin-right: auto;
            padding-left: 0.5rem;
        }
        .copy-btn:hover {
            opacity: 1;
        }
        .copy-btn.copied {
            color: var(--success-feedback) !important;
            opacity: 1;
        }

        /* --- أنماط النافذة المنبثقة (Modal) --- */
        .modal-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.7);
            z-index: 40;
            display: none;
            backdrop-filter: blur(5px);
        }
        .modal {
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            background-color: var(--bg-light);
            border: 1px solid var(--border-color);
            border-radius: 1rem;
            padding: 1.5rem;
            width: 90%;
            max-width: 400px;
            z-index: 50;
            display: none;
            box-shadow: 0 10px 30px rgba(0,0,0,0.5);
        }
        .modal-close-btn {
            position: absolute;
            top: 1rem;
            left: 1rem;
            background: none;
            border: none;
            color: var(--text-color);
            font-size: 1.5rem;
            cursor: pointer;
            opacity: 0.7;
            transition: opacity 0.2s ease;
        }
        .modal-close-btn:hover {
            opacity: 1;
        }

        /* --- أزرار النافذة المنبثقة (اتصل بنا) --- */
        .modal-icon-link {
            display: flex;
            align-items: center;
            background-color: var(--bg-dark);
            border: 1px solid var(--border-color);
            padding: 0.75rem 1rem;
            border-radius: 0.5rem;
            text-decoration: none;
            color: var(--text-color);
            transition: background-color 0.2s ease, box-shadow 0.2s ease;
        }
        .modal-icon-link:hover {
            background-color: #222c3d;
            box-shadow: 0 0 10px rgba(255, 215, 0, 0.3);
        }
        .modal-icon-link svg {
            width: 24px;
            height: 24px;
            margin-left: 0.75rem;
            color: var(--primary-color);
        }

        /* --- الأزرار العائمة (اتصل بنا + المفضلة) --- */
        /* --- [تعديل] إعادة زر "اتصل بنا" إلى وضعه الأصلي --- */
        #contact-us-btn {
            background-color: var(--primary-color);
            color: var(--bg-dark);
            padding: 0.5rem 0.75rem;
            border-radius: 0.5rem;
            border: none;
            cursor: pointer;
            font-weight: 600;
            box-shadow: 0 4px 10px rgba(255, 215, 0, 0.3);
            transition: all 0.2s ease;
            display: flex;
            align-items: center;
            gap: 0.25rem;
        }
        #contact-us-btn:hover {
            background-color: var(--secondary-color);
            box-shadow: 0 6px 15px rgba(255, 215, 0, 0.4);
            transform: scale(1.05);
        }
        
        /* --- [إزالة] تم حذف زر تثبيت التطبيق --- */

        /* --- أنماط سجل البحث --- */
        .history-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            background-color: var(--bg-dark);
            padding: 0.75rem 1rem;
            border-radius: 0.5rem;
            border: 1px solid var(--border-color);
            cursor: pointer;
            transition: background-color 0.2s ease;
        }
        .history-item:hover {
            background-color: #222c3d;
        }
        .history-item span {
            font-size: 0.875rem;
            color: var(--text-color);
            overflow: hidden;
            text-overflow: ellipsis;
            white-space: nowrap;
        }
        .history-item .history-type {
            font-size: 0.75rem;
            color: var(--primary-color);
            flex-shrink: 0;
            margin-left: 0.5rem;
        }

        /* --- [جديد] أنماط عداد VIN --- */
        #vin-counter {
            font-size: 0.75rem;
            font-family: 'Lato', sans-serif;
            margin-right: 0.5rem;
            color: var(--error-color); /* افتراضي أحمر */
        }
        #vin-counter.valid {
            color: var(--success-feedback); /* أخضر */
        }
        
        /* --- [جديد] أنماط "لا توجد نتائج" --- */
        .empty-state-container {
            text-align: center;
            padding: 2rem 1rem;
            border: 2px dashed #4a5568; /* gray-600 */
            border-radius: 0.5rem;
            margin-top: 1rem;
        }
        .empty-state-container svg {
            width: 48px;
            height: 48px;
            margin: 0 auto 1rem auto;
            color: #9ca3af; /* gray-400 */
        }
        .empty-state-container p {
            font-weight: 600;
            color: #cbd5e0; /* gray-300 */
        }

        /* --- [إزالة] تم حذف جميع أنماط قفل الأمان --- */

    </style>
</head>
<body class="min-h-screen flex flex-col p-4">

    <!-- [إزالة] تم حذف زر تثبيت التطبيق -->

    <!-- [إزالة] تم حذف قفل الأمان -->


    <!-- نافذة "اتصل بنا" -->
    <div id="contact-modal-overlay" class="modal-overlay"></div>
    <div id="contact-modal" class="modal">
        <button id="contact-modal-close-btn" class="modal-close-btn">&times;</button>
        <h3 class="text-xl font-bold text-center text-gold mb-4">تواصل معنا</h3>
        <p class="text-center text-gray-300 mb-6">نستقبل جميع آرائكم واقتراحاتكم</p>
        
        <div class="space-y-4">
            <!-- رابط واتساب -->
            <a href="https://wa.me/9647828937302" target="_blank" rel="noopener noreferrer" class="modal-icon-link">
                <svg fill="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg">
                    <path d="M12.04 2C6.58 2 2.13 6.45 2.13 11.91C2.13 13.66 2.59 15.36 3.45 16.86L2.06 21.94L7.31 20.58C8.75 21.38 10.36 21.82 12.04 21.82C17.5 21.82 21.95 17.37 21.95 11.91C21.95 6.45 17.5 2 12.04 2ZM12.04 20.13C10.5 20.13 9.01 19.72 7.7 18.96L7.33 18.73L4.31 19.59L5.19 16.67L4.95 16.29C4.1 14.89 3.64 13.34 3.64 11.91C3.64 7.33 7.42 3.54 12.04 3.54C16.66 3.54 20.44 7.33 20.44 11.91C20.44 16.49 16.66 20.13 12.04 20.13ZM17.9 14.49C17.65 14.37 16.65 13.88 16.43 13.8C16.2 13.72 16.03 13.68 15.86 13.92C15.69 14.16 15.17 14.75 15 14.92C14.83 15.09 14.66 15.11 14.41 14.99C13.93 14.76 13.06 14.44 12.06 13.54C11.26 12.84 10.7 12.01 10.58 11.77C10.46 11.53 10.58 11.41 10.69 11.3C10.79 11.2 10.92 11.04 11.05 10.89C11.18 10.74 11.22 10.62 11.3 10.45C11.38 10.28 11.34 10.12 11.28 10C11.22 9.88 10.78 8.84 10.6 8.42C10.42 8 10.24 8.04 10.09 8.03C9.95 8.02 9.77 8.02 9.6 8.02C9.43 8.02 9.18 8.06 8.97 8.29C8.76 8.52 8.24 9.01 8.24 10.05C8.24 11.09 8.99 12.09 9.11 12.26C9.23 12.43 10.74 14.85 13.11 15.85C13.76 16.14 14.28 16.3 14.71 16.41C15.29 16.56 15.79 16.52 16.21 16.3C16.67 16.06 17.53 15.49 17.75 14.8C17.97 14.11 17.97 13.56 17.9 13.44C17.82 13.31 17.65 13.23 17.41 13.11L17.9 14.49Z"/>
                </svg>
                <span>مراسلة عبر واتساب</span>
            </a>
            <!-- رابط الموقع الرسمي -->
            <a href="https://iqsd2020-ctrl.github.io/Web/" target="_blank" rel="noopener noreferrer" class="modal-icon-link">
                <svg fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg">
                    <path stroke-linecap="round" stroke-linejoin="round" d="M12 2C6.48 2 2 6.48 2 12s4.48 10 10 10 10-4.48 10-10S17.52 2 12 2zM4 12c0-1.04.15-2.04.42-3h15.16c.27.96.42 1.96.42 3s-.15 2.04-.42 3H4.42C4.15 14.04 4 13.04 4 12zm8 8c-1.93 0-3.68-.78-4.95-2.05L8.4 16.6c.7.3 1.45.5 2.25.6c.8.1 1.6.1 2.4-.1c.8-.2 1.55-.4 2.25-.7l1.35 1.35C15.68 19.22 13.93 20 12 20zm0-16c1.93 0 3.68.78 4.95 2.05L15.6 7.4c-.7-.3-1.45-.5-2.25-.6c-.8-.1-1.6-.1-2.4.1c-.8.2-1.55.4-2.25.7L7.05 4.05C8.32 2.78 10.07 2 12 2z"></path>
                </svg>
                <span>زيارة الموقع الرسمي</span>
            </a>
        </div>
    </div>


    <main class="flex-grow flex items-center justify-center relative pt-16 sm:pt-4"> <!-- [جديد] relative and padding -->
        <!-- [جديد] نقل زر "اتصل بنا" ليصبح ملتصقاً بالجانب -->
        <button id="contact-us-btn" class="absolute top-4 left-4 sm:left-6 md:left-8">
            اتصل بنا
        </button>

        <!-- حاوية التطبيق الرئيسية --><div class="w-full max-w-lg p-4 sm:p-6 md:p-8 card-container">
        
        <h1 class="text-3xl font-bold text-center mb-6 text-gold latin-font">
            MASTER KEY
        </h1>
        <p class="text-center text-sm mb-8 text-gray-400">
            ابحث عن معلومات الريموتات لسيارتك بدقة وفعالية.
        </p>

        <!-- حاوية التبويبات -->
        <div class="flex border-b border-gray-700 mb-6">
            <button id="specs-tab" class="tab-btn active">البحث بالمواصفات</button>
            <button id="reverse-tab" class="tab-btn">البحث العكسي</button>
            <button id="vin-tab" class="tab-btn">البحث بالـ VIN</button>
        </div>

        <form id="ai-form" class="mb-6">
            
            <!-- لوحة البحث بالمواصفات (افتراضي) -->
            <div id="specs-search-panel" class="search-panel active space-y-5">
                <!-- السنة -->
                <div>
                    <label for="year" class="block text-sm font-medium mb-1 text-gray-300">السنة</label>
                    <input type="number" id="year" name="year" class="w-full p-3 latin-font app-input" placeholder="مثال: 2024">
                </div>
                
                <!-- ماركة السيارة -->
                <div class="relative">
                    <label for="type" class="block text-sm font-medium mb-1 text-gray-300">ماركة السيارة</label>
                    <input type="text" id="type" name="type" class="w-full p-3 app-input" placeholder="مثال: تويوتا" autocomplete="off">
                    <div id="type-suggestions" class="autocomplete-suggestions"></div>
                </div>
                
                <!-- الطراز -->
                <div class="relative">
                    <label for="model" class="block text-sm font-medium mb-1 text-gray-300">الطراز</label>
                    <input type="text" id="model" name="model" class="w-full p-3 app-input" placeholder="مثال: كامري" autocomplete="off">
                    <div id="model-suggestions" class="autocomplete-suggestions"></div>
                </div>

                <!-- السوق -->
                <div>
                    <label for="market" class="block text-sm font-medium mb-1 text-gray-300">السوق</label>
                    <select id="market" name="market" class="w-full p-3 app-input">
                        <option value="" disabled selected>اختر السوق...</option>
                        <option value="american">السوق الأمريكي</option>
                        <option value="european">السوق الأوروبي</option>
                        <option value="asian">السوق الآسيوي</option>
                        <option value="korean">السوق الكوري</option>
                        <option value="gulf">السوق الخليجي</option>
                        <option value="chinese">السوق الصيني</option>
                        <option value="global">السوق العالمي</option>
                    </select>
                </div>
            </div>

            <!-- لوحة البحث العكسي (مخفي) -->
            <div id="reverse-search-panel" class="search-panel space-y-5">
                <div>
                    <label for="fcc_input" class="block text-sm font-medium mb-1 text-gray-300">FCC ID</label>
                    <input type="text" id="fcc_input" name="fcc_input" class="w-full p-3 latin-font app-input" placeholder="مثال: HYQ14FBA" style="text-transform: uppercase;">
                </div>
                <div>
                    <label for="pn_input" class="block text-sm font-medium mb-1 text-gray-300">Part Number (P/N)</label>
                    <input type="text" id="pn_input" name="pn_input" class="w-full p-3 latin-font app-input" placeholder="مثال: 89904-0E120" style="text-transform: uppercase;">
                </div>
                <p class="text-xs text-gray-400 text-center">أدخل أحد الحقلين أو كلاهما لنتائج أدق.</p>
            </div>

            <!-- لوحة البحث بالـ VIN (مخفي) -->
            <div id="vin-search-panel" class="search-panel space-y-5">
                <div>
                    <div class="flex justify-between items-center mb-1">
                        <label for="vin_input" class="block text-sm font-medium text-gray-300">رقم الشاصي (VIN)</label>
                        <!-- [جديد] عداد VIN -->
                        <span id="vin-counter">(0/17)</span>
                    </div>
                    <input type="text" id="vin_input" name="vin_input" class="w-full p-3 latin-font app-input" placeholder="أدخل 17 رمزاً..." maxlength="17" style="text-transform: uppercase;">
                </div>
                <p class="text-xs text-gray-400 text-center">سيقوم النظام بتحليل الـ VIN والبحث عن القطع المطابقة.</p>
                <p class="text-xs text-yellow-400 text-center bg-gray-800 p-2 rounded-md border border-yellow-500">
                    ملاحظة: هذه الوظيفة تجريبية ولا يمكن الاعتماد عليها مع السيارات الحديثة.
                </p>
            </div>
            
            
            <!-- أزرار الإجراءات (مشتركة) --><div class="flex flex-col sm:flex-row gap-4 pt-4">
                <button type="submit" class="w-full sm:w-3/4 py-3 app-button flex items-center justify-center">
                    <span id="progress-text" class="w-full text-center">ابحث عن الريموت</span>
                    <div id="loader" class="loader hidden"></div>
                </button>
                <button type="button" id="clear-form-btn" class="w-full sm:w-1/4 py-3 clear-button latin-font">
                    مسح
                </button>
            </div>
        </form>
        
        <!-- منطقة عرض النتائج --><div id="result-container" class="mt-8">
            <h2 class="text-xl font-semibold mb-4 text-gray-200" id="results-title" style="display: none;">النتائج:</h2>
            <div id="result-box" class="space-y-4">
                <!-- النتائج ستظهر هنا -->
            </div>
            <p id="message-box" class="mt-4 p-3 rounded-md text-center text-sm font-medium" style="display: none; background-color: var(--secondary-color); color: white;"></p>
        </div>
        
        <!-- منطقة سجل البحث -->
        <div id="history-container" class="mt-8 w-full" style="display: none;">
            <div class="flex justify-between items-center mb-4">
                <h2 class="text-xl font-semibold text-gray-200">سجل البحث</h2>
                <button id="clear-history-btn" class="text-sm text-red-400 hover:text-red-300 transition-colors">
                    &times; مسح السجل
                </button>
            </div>
            <div id="history-box" class="space-y-2 max-h-48 overflow-y-auto pr-2">
                <!-- عناصر السجل ستظهر هنا -->
            </div>
        </div>

    </div>
    </main>

    <!-- Footer with Copyright Link -->
    <footer class="w-full max-w-lg text-center py-4 mx-auto">
        <a href="https://iqsd2020-ctrl.github.io/Web/" 
           target="_blank" 
           rel="noopener noreferrer" 
           class="text-sm text-gold hover:text-yellow-300 hover:underline transition-colors duration-200">
            جميع الحقوق محفوظة &copy; MASTER KEY
        </a>
    </footer>

    <!-- [جديد] قالب "لا توجد نتائج" -->
    <template id="empty-state-template">
        <div class="empty-state-container">
            <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor">
                <path stroke-linecap="round" stroke-linejoin="round" d="m21 21-5.197-5.197m0 0A7.5 7.5 0 1 0 5.196 5.196a7.5 7.5 0 0 0 10.607 10.607Z" />
            </svg>
            <p>لم يتم العثور على نتائج مطابقة</p>
            <p class="text-sm text-gray-400 font-normal mt-1">الرجاء التأكد من البيانات المدخلة والمحاولة مجدداً.</p>
        </div>
    </template>


    <script>
        // --- [جديد] مفاتيح API ---
        // ==========================================
        // [تعديل] تم تحديث المفتاح بناءً على طلبك
        // ==========================================
        const GEMINI_API_KEY = "AIzaSyByERNaTPUtuleb62ok6YAOlADKoiSM-zM";
        const DEEPSEEK_API_KEY = "sk-3ac8d0208edd4ada9e949eb366a4a262";

        // --- متغيرات العناصر الأساسية ---
        const form = document.getElementById('ai-form');
        const resultContainer = document.getElementById('result-container');
        const resultBox = document.getElementById('result-box');
        const messageBox = document.getElementById('message-box');
        const progressText = document.getElementById('progress-text');
        const loader = document.getElementById('loader');
        const resultsTitle = document.getElementById('results-title');
        const clearFormBtn = document.getElementById('clear-form-btn');
        const submitButton = form.querySelector('button[type="submit"]');
        
        // --- متغيرات نوافذ Modal ---
        const contactButton = document.getElementById('contact-us-btn');
        const contactModalOverlay = document.getElementById('contact-modal-overlay');
        const contactModal = document.getElementById('contact-modal');
        const contactCloseModalBtn = document.getElementById('contact-modal-close-btn');

        // --- متغيرات الاقتراحات (Autocomplete) ---
        const typeInput = document.getElementById('type');
        const modelInput = document.getElementById('model');
        const typeSuggestions = document.getElementById('type-suggestions');
        const modelSuggestions = document.getElementById('model-suggestions');
        const vinInput = document.getElementById('vin_input');
        const vinCounter = document.getElementById('vin-counter'); // [جديد]
        
        let carMakes = [];
        let carModels = [];
        
        const carMakesUrl = 'https://raw.githubusercontent.com/iqsd2020-ctrl/Sjad/refs/heads/main/%D9%85%D8%A7%D8%B1%D9%83%D8%A7%D8%AA%20%D8%A7%D9%84%D8%B3%D9%8A%D8%A7%D8%B1%D8%A7%D8%AA.csv';
        const carModelsUrl = 'https://raw.githubusercontent.com/iqsd2020-ctrl/Sjad/refs/heads/main/%D8%B7%D8%B1%D8%A7%D8%B2%D8%A7%D8%AA%20%D8%A7%D9%84%D8%B3%D9%8A%D8%A7%D8%B1%D8%A7%D8%AA.csv';
        
        // --- متغيرات التبويبات (Tabs) ---
        let currentSearchMode = 'specs'; // 'specs', 'reverse', 'vin'
        const tabs = document.querySelectorAll('.tab-btn');
        const panels = document.querySelectorAll('.search-panel');

        // --- متغيرات سجل البحث ---
        const historyContainer = document.getElementById('history-container');
        const historyBox = document.getElementById('history-box');
        const clearHistoryBtn = document.getElementById('clear-history-btn');
        const MAX_HISTORY = 10;
        
        // --- [جديد] Regex للتحقق من VIN ---
        const VIN_REGEX = /^[A-HJ-NPR-Z0-9]{17}$/;


        // --- دوال فتح وإغلاق النوافذ ---
        function openModal(modal, overlay) {
            overlay.style.display = 'block';
            modal.style.display = 'block';
        }
        function closeModal(modal, overlay) {
            overlay.style.display = 'none';
            modal.style.display = 'none';
        }

        // --- ربط أحداث النوافذ ---
        contactButton.addEventListener('click', () => openModal(contactModal, contactModalOverlay));
        contactCloseModalBtn.addEventListener('click', () => closeModal(contactModal, contactModalOverlay));
        contactModalOverlay.addEventListener('click', () => closeModal(contactModal, contactModalOverlay));


        // --- معالج تبديل التبويبات ---
        tabs.forEach(tab => {
            tab.addEventListener('click', () => {
                tabs.forEach(t => t.classList.remove('active'));
                panels.forEach(p => p.classList.remove('active'));
                
                tab.classList.add('active');
                const targetPanelId = tab.id.replace('-tab', '-search-panel');
                document.getElementById(targetPanelId).classList.add('active');
                
                currentSearchMode = tab.id.split('-')[0];
                
                resultBox.innerHTML = '';
                resultsTitle.style.display = 'none';
                messageBox.style.display = 'none';
            });
        });

        // *** معالج حدث إرسال النموذج ***
        form.addEventListener('submit', async function(event) {
            event.preventDefault(); 
            
            messageBox.style.display = 'none';
            resultBox.innerHTML = '';
            resultsTitle.style.display = 'none';

            progressText.style.display = 'none';
            loader.classList.remove('hidden');
            submitButton.disabled = true;

            let userQuery = '';
            let systemInstruction = '';
            let displayTitle = { make: '', model: '', year: '' };
            let searchData = {};
            let resultData = {}; 

            try {
                if (currentSearchMode === 'specs') {
                    const year = document.getElementById('year').value;
                    const type = typeInput.value;
                    const model = modelInput.value;
                    const market = document.getElementById('market').value;
                    
                    if (!type || !model || !year || !market) {
                        throw new Error("الرجاء ملء جميع حقول البحث بالمواصفات.");
                    }

                    userQuery = createSpecsQuery(year, type, model, market);
                    systemInstruction = createSpecsSystemInstruction();
                    displayTitle = { make: type, model: model, year: year };
                    
                    searchData = {
                        mode: 'specs',
                        id: `specs-${year}-${type}-${model}-${market}`,
                        title: `${year} - ${type} - ${model} (${market})`,
                        typeDisplay: 'مواصفات',
                        tabId: 'specs-tab',
                        data: { year, type, model, market }
                    };
                    
                    resultData = { 
                        type: 'specs',
                        title: `${type} ${model} ${year}`,
                        id: `specs-res-${Date.now()}`
                    };

                } else if (currentSearchMode === 'vin') {
                    const vin = vinInput.value.toUpperCase();
                    
                    if (!vin || !VIN_REGEX.test(vin)) {
                        throw new Error("الرجاء إدخال رقم VIN صحيح (17 رمزاً، بدون الأحرف I, O, Q).");
                    }
                    
                    userQuery = createVinQuery(vin); 
                    systemInstruction = createVinSystemInstruction(); // <-- [تعديل] استخدام تعليمات VIN الجديدة
                    displayTitle = { make: 'VIN', model: vin, year: '' }; // سيبقى هذا كما هو، سيتم التجاوز في العرض
                    
                    searchData = {
                        mode: 'vin',
                        id: `vin-${vin}`,
                        title: `VIN: ${vin}`,
                        typeDisplay: 'VIN',
                        tabId: 'vin-tab',
                        data: { vin }
                    };
                    
                    resultData = { 
                        type: 'vin', // <-- [تعديل] تغيير النوع إلى 'vin' للتمييز
                        title: `VIN: ${vin}`,
                        id: `vin-res-${vin}`
                    };

                } else if (currentSearchMode === 'reverse') {
                    const fccId = document.getElementById('fcc_input').value.toUpperCase();
                    const partNumber = document.getElementById('pn_input').value.toUpperCase();

                    if (!fccId && !partNumber) {
                        throw new Error("الرجاء إدخال FCC ID أو Part Number للبحث العكسي.");
                    }
                    
                    userQuery = createReverseQuery(fccId, partNumber);
                    systemInstruction = createReverseSystemInstruction();
                    displayTitle = { fccId: fccId, partNumber: partNumber };
                    
                    searchData = {
                        mode: 'reverse',
                        id: `reverse-${fccId}-${partNumber}`,
                        title: `${fccId || ''} / ${partNumber || ''}`,
                        typeDisplay: 'عكسي',
                        tabId: 'reverse-tab',
                        data: { fccId, partNumber }
                    };
                    
                    resultData = { 
                        type: 'reverse',
                        title: `${fccId || ''} / ${partNumber || ''}`,
                        id: `reverse-res-${fccId}-${partNumber}`
                    };
                }
                
                // --- [تعديل] منطق الاتصال الاحتياطي ---
                let rawText;
                try {
                    console.log("Attempting search with Gemini...");
                    rawText = await callGeminiAPI(userQuery, systemInstruction);
                } catch (geminiError) {
                    console.warn("Gemini API failed:", geminiError.message);
                    showMessage("فشل الخادم الأول. جارٍ المحاولة بالخادم الاحتياطي...", 'info');
                    
                    try {
                        console.log("Attempting search with DeepSeek...");
                        rawText = await callDeepSeekAPI(userQuery, systemInstruction); 
                    } catch (deepSeekError) {
                        console.error("DeepSeek API failed:", deepSeekError.message);
                        throw new Error("فشل الاتصال بكلا الخادمين. الرجاء المحاولة لاحقاً.");
                    }
                }
                // --- [نهاية] منطق الاتصال الاحتياطي ---
                
                saveToHistory(searchData);
                
                resultData.rawText = rawText; 
                
                let resultsFound = false;
                if (currentSearchMode === 'specs' || currentSearchMode === 'vin') {
                    // سيتم استدعاء نفس الدالة، لكنها ستحتوي على منطق جديد
                    resultsFound = displaySpecsResults(rawText, displayTitle, resultData);
                } else if (currentSearchMode === 'reverse') {
                    resultsFound = displayReverseResults(rawText, displayTitle, resultData);
                }
                
                if (!resultsFound) {
                    showEmptyState();
                } else {
                    showMessage('تم العثور على نتائج بنجاح!', 'success');
                }

            } catch (error) {
                console.error("Submit Error:", error);
                showMessage(error.message || 'حدث خطأ غير متوقع. الرجاء المحاولة مرة أخرى.', 'error');
            } finally {
                loader.classList.add('hidden');
                progressText.style.display = 'block';
                submitButton.disabled = false;
            }
        });
        
        // معالج زر المسح
        clearFormBtn.addEventListener('click', function() {
            const activePanel = document.querySelector('.search-panel.active');
            if (activePanel) {
                activePanel.querySelectorAll('input, select').forEach(el => {
                    if (el.tagName === 'SELECT') {
                        el.selectedIndex = 0;
                    } else {
                        el.value = '';
                    }
                });
            }
            if (currentSearchMode === 'vin') {
                updateVinCounter(0);
            }
            
            messageBox.style.display = 'none';
            resultBox.innerHTML = '';
            resultsTitle.style.display = 'none';
        });

        // --- دوال إنشاء الاستعلامات ---
        function createSpecsQuery(year, type, model, market) {
            return `ابحث عن بيانات الريموت لسيارة:
- الماركة: ${type}
- الطراز: ${model}
- السنة: ${year}
- السوق: ${market}
ابحث عن FCC ID و Part Number ونوع الريموت ونوع نصل المفتاح (مثل TOY48 أو KK12).
ابحث أيضًا عن 2-3 احتمالات أو بدائل شائعة إذا كانت متوفرة.
---
${getSpecsFormatInstruction()}`;
        }
        
        function createVinQuery(vin) {
            return `مهم للغاية: لديك مهمتان متسلسلسان.
المهمة 1 (التحقق أولاً): خذ رقم VIN التالي: ${vin}. ابحث في Google ومواقع فك تشفير VIN (مثل partsouq.com أو carfax.com أو أي VIN decoder) لتحديد **بدقة** ما هي "الماركة" و "الطراز" و "السنة" الحقيقية. قم بمطابقة النتائج من أكثر من موقع. لا تفترض، بل تحقق.
المهمة 2 (البحث ثانياً): *فقط بعد أن تتحقق من معلومات السيارة من المهمة 1*، استخدم هذه المعلومات (الماركة، الطراز، السنة) للبحث عن بيانات الريموت الخاصة بها.
ابحث عن: FCC ID, PartNumber, نوع الريموت, نصل المفتاح.
وابحث عن 2-3 بدائل.
---
${getVinFormatInstruction()}`; // <-- [تعديل] استخدام تنسيق VIN الجديد
        }
        
        function createReverseQuery(fccId, partNumber) {
            return `ابحث عن السيارات المتوافقة مع:
- FCC ID: ${fccId || 'N/A'}
- Part Number: ${partNumber || 'N/A'}
اذكر 5-7 سيارات متوافقة، مع ذكر الطراز، سنوات التصنيع، وأي ملاحظات هامة.
---
الرجاء تنسيق الرد **فقط** بالشكل التالي (لا تضف أي نص إضافي):
CAR_1_MODEL: [الطراز 1]
CAR_1_YEARS: [سنوات التصنيع 1]
CAR_1_NOTES: [ملاحظات 1 أو "N/A"]
...
CAR_7_MODEL: [الطراز 7]
CAR_7_YEARS: [سنوات التصنيع 7]
CAR_7_NOTES: [ملاحظات 7 أو "N/A"]
`;
        }
        
        // --- دوال إنشاء تعليمات النظام ---
        function getSpecsFormatInstruction() {
            return `الرجاء تنسيق الرد **فقط** بالشكل التالي (لا تضف أي نص إضافي، استخدم "غير متوفر" أو "N/A" إذا لم تُعثر على بيانات):
FCC_ID: [البيانات أو "غير متوفر"]
PART_NUMBER: [البيانات أو "غير متوفر"]
REMOTE_TYPE: [البيانات أو "غير متوفر"]
KEY_BLADE: [البيانات أو "غير متوفر"]
ALT_1_FCC: [بيانات البديل 1 أو "N/A"]
ALT_1_PN: [بيانات البديل 1 أو "N/A"]
ALT_1_NOTES: [ملاحظات 1 أو "N/A"]
ALT_2_FCC: [بيانات البديل 2 أو "N/A"]
ALT_2_PN: [بيانات البديل 2 أو "N/A"]
ALT_2_NOTES: [ملاحظات 2 أو "N/A"]
ALT_3_FCC: [بيانات البديل 3 أو "N/A"]
ALT_3_PN: [بيانات البديل 3 أو "N/A"]
ALT_3_NOTES: [ملاحظات 3 أو "N/A"]`;
        }

        // --- [جديد] دالة تعليمات تنسيق خاصة بالـ VIN ---
        function getVinFormatInstruction() {
            return `الرجاء تنسيق الرد **فقط** بالشكل التالي (لا تضف أي نص إضافي، استخدم "غير متوفر" أو "N/A" إذا لم تُعثر على بيانات):
MAKE: [الماركة التي وجدتها]
MODEL: [الطراز الذي وجدته]
YEAR: [السنة التي وجدتها]
FCC_ID: [البيانات أو "غير متوفر"]
PART_NUMBER: [البيانات أو "غير متوفر"]
REMOTE_TYPE: [البيانات أو "غير متوفر"]
KEY_BLADE: [البيانات أو "غير متوفر"]
ALT_1_FCC: [بيانات البديل 1 أو "N/A"]
ALT_1_PN: [بيانات البديل 1 أو "N/A"]
ALT_1_NOTES: [ملاحظات 1 أو "N/A"]
ALT_2_FCC: [بيانات البديل 2 أو "N/A"]
ALT_2_PN: [بيانات البديل 2 أو "N/A"]
ALT_2_NOTES: [ملاحظات 2 أو "N/A"]
ALT_3_FCC: [بيانات البديل 3 أو "N/A"]
ALT_3_PN: [بيانات البديل 3 أو "N/A"]
ALT_3_NOTES: [ملاحظات 3 أو "N/A"]`;
        }

        function createSpecsSystemInstruction() {
            return {
                parts: [{ text: "أنت مساعد خبير في قطع غيار السيارات، متخصص في ريموتات المفاتيح. ابحث عن المعلومات المطلوبة بدقة والتزم **تماماً** بالتنسيق المطلوب في نهاية طلب المستخدم. لا تضف أي مقدمات أو خواتيم. يجب أن تكون جميع القيم باللغة العربية باستثناء FCC ID و Part Number و Key Blade." }]
            };
        }
        function createReverseSystemInstruction() {
             return {
                parts: [{ text: "أنت مساعد خبير في قطع غيار السيارات. ابحث عن السيارات المتوافقة والتزم **تماماً** بالتنسيق المطلوب (CAR_1_MODEL, CAR_1_YEARS...). لا تضف أي مقدمات أو خواتيم." }]
            };
        }
        
        // --- [جديد] دالة تعليمات نظام خاصة بالـ VIN ---
        function createVinSystemInstruction() {
            return {
                parts: [{ text: "أنت مساعد خبير في قطع غيار السيارات. مهمتك الأولى هي فك تشفير VIN للعثور على الماركة والطراز والسنة. مهمتك الثانية هي العثور على معلومات الريموت لتلك السيارة. التزم **تماماً** بالتنسيق المطلوب (MAKE, MODEL, YEAR, FCC_ID...). لا تضف أي مقدمات أو خواتيم." }]
            };
        }

        // --- دالة الاتصال بالـ API ---
        async function callGeminiAPI(userQuery, systemInstruction) {
            // ==========================================
            // [إصلاح] تم إصلاح هذه الدالة
            // 1. تم حذف الإعلان المحلي للمفتاح
            // 2. تم إصلاح الرابط ليستخدم المتغير العام الصحيح GEMINI_API_KEY
            // ==========================================
            
            // [تعديل] استخدام المتغير العام للمفتاح
            const apiUrl = `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-09-2025:generateContent?key=${GEMINI_API_KEY}`;

            const payload = {
                contents: [{ parts: [{ text: userQuery }] }],
                systemInstruction: systemInstruction,
                tools: [{ "google_search": {} }]
            };
            
            const response = await fetchWithRetry(apiUrl, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(payload)
            });

            const rawText = response.candidates?.[0]?.content?.parts?.[0]?.text;
            if (!rawText || rawText.trim() === '') {
                throw new Error("لم يتم العثور على معلومات مفيدة من الـ API.");
            }
            return rawText;
        }

        async function callDeepSeekAPI(userQuery, systemInstruction) {
            // [تعديل] استخدام المتغير العام للمفتاح
            const apiKey = DEEPSEEK_API_KEY; 
            const apiUrl = `https://api.deepseek.com/chat/completions`;

            console.warn("Calling DeepSeek. Note: Google Search grounding is not available for this API. Results may vary.");

            const payload = {
                model: "deepseek-chat",
                messages: [
                    { "role": "system", "content": systemInstruction.parts[0].text },
                    { "role": "user", "content": userQuery }
                ]
            };

            const options = {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'Authorization': `Bearer ${apiKey}`
                },
                body: JSON.stringify(payload)
            };

            // Custom retry logic for DeepSeek
            let delay = 1000;
            for (let i = 0; i < 3; i++) {
                try {
                    const response = await fetch(apiUrl, options);
                    if (response.ok) {
                        const data = await response.json();
                        const rawText = data.choices?.[0]?.message?.content;
                        if (!rawText || rawText.trim() === '') {
                            throw new Error("لم يتم العثور على معلومات مفيدة من DeepSeek API.");
                        }
                        return rawText;
                    }
                    if (response.status === 429 || response.status >= 500) {
                        await new Promise(res => setTimeout(res, delay));
                        delay *= 2;
                    } else {
                        const errorData = await response.json();
                        throw new Error(`DeepSeek Client Error: ${response.status} - ${errorData.error?.message || 'Unknown error'}`);
                    }
                } catch (error) {
                    if (i === 2) throw error; // Re-throw last error
                    await new Promise(res => setTimeout(res, delay));
                    delay *= 2;
                }
            }
            throw new Error("فشل الاتصال بـ DeepSeek API بعد عدة محاولات.");
        }


        // --- دوال عرض النتائج ---

        // دالة مساعدة لاستخراج البيانات
        function extract(rawText, key) {
            const regex = new RegExp(`^${key}: (.*)`, "im"); 
            const match = rawText.match(regex);
            return match && match[1] ? match[1].trim() : "غير متوفر";
        }
        
        // [تحسين] دالة عرض "لا توجد نتائج"
        function showEmptyState() {
            resultsTitle.style.display = 'none'; // إخفاء عنوان "النتائج"
            const template = document.getElementById('empty-state-template');
            const clone = template.content.cloneNode(true);
            resultBox.appendChild(clone);
        }
            
        // [تحسين] دالة عرض نتائج البحث بالمواصفات أو VIN
        function displaySpecsResults(rawText, title, resultData) {
            resultBox.innerHTML = ''; 

            const fccId = extract(rawText, "FCC_ID");
            const partNumber = extract(rawText, "PART_NUMBER");
            
            if ((fccId === "غير متوفر" || fccId === "N/A") && (partNumber === "غير متوفر" || partNumber === "N/A")) {
                return false; 
            }
            
            resultsTitle.style.display = 'block'; 
            const remoteType = extract(rawText, "REMOTE_TYPE");
            const keyBlade = extract(rawText, "KEY_BLADE");
            
            // --- [تعديل] منطق جديد لتحديد العنوان بناءً على نوع البحث ---
            let headerTitle = '';
            
            if (resultData.type === 'vin') {
                const apiMake = extract(rawText, "MAKE");
                const apiModel = extract(rawText, "MODEL");
                const apiYear = extract(rawText, "YEAR");
                
                if (apiMake !== "غير متوفر" && apiMake !== "N/A" && apiModel !== "غير متوفر" && apiModel !== "N/A") {
                    // إذا وجدنا معلومات السيارة من الـ API
                    headerTitle = `${apiMake} ${apiModel} ${apiYear || ''}`;
                    // نقوم بتحديث كائن resultData ليتم استخدامه في "المشاركة"
                    resultData.title = headerTitle; // تحديث العنوان
                } else {
                    // إذا فشل الـ API في إيجاد السيارة، نستخدم الـ VIN كعنوان احتياطي
                    headerTitle = `نتائج للـ VIN: ${title.model}`; // title.model يحتوي على رقم الـ VIN
                }
            } else {
                // (currentSearchMode === 'specs')
                // السلوك القديم: استخدم العنوان من مدخلات المستخدم
                headerTitle = `${title.make} ${title.model} ${title.year}`;
            }
            // --- [نهاية التعديل] ---

            resultData.fccId = fccId;
            resultData.partNumber = partNumber;
            resultData.keyBlade = keyBlade;
            resultData.remoteType = remoteType;
            
            const copyIconSvgPath = `<path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 16H6a2 2 0 01-2-2V6a2 2 0 012-2h8a2 2 0 012 2v2m-6 12h8a2 2 0 002-2v-8a2 2 0 00-2-2h-8a2 2 0 00-2 2v8a2 2 0 002 2z"></path>`;

            const mainResultsHtml = `
                <div class="accordion-header" onclick="toggleAccordion(this)">
                    <h3 class="font-bold text-lg text-white">${headerTitle}</h3> <!-- [تعديل] استخدام المتغير الجديد -->
                    
                    <div class="accordion-actions">
                        <!-- [إزالة] زر الحفظ -->
                        <button class="action-btn" title="مشاركة النتيجة" onclick="shareResult(${JSON.stringify(resultData).replace(/"/g, "'")})">
                             <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" class="w-5 h-5">
                                <path stroke-linecap="round" stroke-linejoin="round" d="M7.217 10.907a2.25 2.25 0 1 0 0 2.186m0-2.186c.19.02.38.05.57.09m0 0c2.083.36 3.997.96 5.681 1.94m0 0c.16.1.31.2.46.3m0 0a2.25 2.25 0 1 0 0-2.186m0 2.186c-.19-.02-.38-.05-.57-.09m0 0c-2.083-.36-3.997-.96-5.681-1.94m0 0c-.16-.1-.31-.2-.46-.3m0 0a2.25 2.25 0 1 0 0 2.186m0-2.186-.57.09" />
                            </svg>
                        </button>
                    </div>

                    <svg class="accordion-icon w-5 h-5 text-gray-400" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7"></path></svg>
                </div>
                <div class="accordion-content">
                    <div class="p-4 border border-gray-700 rounded-lg overflow-x-auto">
                        <table class="results-table">
                            <tbody>
                                <tr>
                                    <td class="font-semibold text-gold pr-4 py-2 w-1/3">FCC ID:</td>
                                    <td class="latin-font py-2 flex justify-between items-center">
                                        <span>${fccId}</span>
                                        ${(fccId !== 'غير متوفر' && fccId !== 'N/A') ? `<svg onclick="copyToClipboard(this.previousElementSibling.textContent, this)" class="copy-btn w-5 h-5 text-gray-400" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg">${copyIconSvgPath}</svg>` : ''}
                                    </td>
                                </tr>
                                <tr>
                                    <td class="font-semibold text-gold pr-4 py-2">Part Number:</td>
                                    <td class="latin-font py-2 flex justify-between items-center">
                                        <span>${partNumber}</span>
                                        ${(partNumber !== 'غير متوفر' && partNumber !== 'N/A') ? `<svg onclick="copyToClipboard(this.previousElementSibling.textContent, this)" class="copy-btn w-5 h-5 text-gray-400" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg">${copyIconSvgPath}</svg>` : ''}
                                    </td>
                                </tr>
                                <tr>
                                    <td class="font-semibold text-gold pr-4 py-2">نوع الريموت:</td>
                                    <td class="py-2">${remoteType}</td>
                                </tr>
                                <tr>
                                    <td class="font-semibold text-gold pr-4 py-2">نصل المفتاح:</td>
                                    <td class="latin-font py-2 flex justify-between items-center">
                                        <span>${keyBlade}</span>
                                        ${(keyBlade !== 'غير متوفر' && keyBlade !== 'N/A') ? `<svg onclick="copyToClipboard(this.previousElementSibling.textContent, this)" class="copy-btn w-5 h-5 text-gray-400" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg">${copyIconSvgPath}</svg>` : ''}
                                    </td>
                                </tr>
                            </tbody>
                        </table>
                    </div>
                </div>
            `;
            resultBox.innerHTML += mainResultsHtml;

            // بناء وعرض البدائل
            let alternatives = [];
            for (let i = 1; i <= 3; i++) {
                const altFcc = extract(rawText, `ALT_${i}_FCC`);
                const altPn = extract(rawText, `ALT_${i}_PN`);
                const altNotes = extract(rawText, `ALT_${i}_NOTES`);
                
                if ((altFcc !== "غير متوفر" && altFcc !== "N/A") || (altPn !== "غير متوفر" && altPn !== "N/A")) {
                    alternatives.push({
                        fccId: (altFcc && altFcc !== "غير متوفر" && altFcc !== "N/A") ? altFcc : "N/A",
                        partNumber: (altPn && altPn !== "غير متوفر" && altPn !== "N/A") ? altPn : "N/A",
                        notes: (altNotes && altNotes !== "غير متوفر" && altNotes !== "N/A") ? altNotes : "لا توجد ملاحظات."
                    });
                }
            }

            if (alternatives.length > 0) {
                let alternativesHtml = alternatives.map(alt => `
                    <div class="alternative-card space-y-2 mb-3">
                        <div class="flex justify-between items-center">
                            <strong class="text-gray-400">FCC ID:</strong>
                            <span class="latin-font">${alt.fccId}</span>
                        </div>
                        <div class="flex justify-between items-center">
                            <strong class="text-gray-400">Part Number:</strong>
                            <span class="latin-font">${alt.partNumber}</span>
                        </div>
                        <div>
                            <strong class="text-gray-400">ملاحظات:</strong>
                            <p class="text-sm text-gray-300 leading-relaxed mt-1">${alt.notes}</p>
                        </div>
                    </div>
                `).join('');

                const altSectionHtml = `
                    <div class="accordion-header" onclick="toggleAccordion(this)">
                        <h3 class="font-bold text-lg text-white">احتمالات أخرى مطابقة (${alternatives.length})</h3>
                        <svg class="accordion-icon w-5 h-5 text-gray-400" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7"></path></svg>
                    </div>
                    <div class="accordion-content">
                        <div class="p-4 border border-gray-700 rounded-lg scrollable-card-container">
                            ${alternativesHtml}
                        </div>
                    </div>
                `;
                resultBox.innerHTML += altSectionHtml;
            } else {
                 resultBox.innerHTML += `
                    <p class="text-gray-400 text-center py-4">لا توجد بدائل شائعة مسجلة لهذه المواصفات.</p>
                `;
            }
            
            const firstAccordion = resultBox.querySelector('.accordion-header');
            if(firstAccordion) {
                firstAccordion.click();
            }
            
            return true;
        }
        
        // [تحسين] دالة عرض نتائج البحث العكسي
        function displayReverseResults(rawText, title, resultData) {
            resultBox.innerHTML = '';
            
            let cars = [];
            for (let i = 1; i <= 7; i++) {
                const model = extract(rawText, `CAR_${i}_MODEL`);
                const years = extract(rawText, `CAR_${i}_YEARS`);
                const notes = extract(rawText, `CAR_${i}_NOTES`);
                
                if (model !== "غير متوفر" && model !== "N/A") {
                    cars.push({ model, years, notes });
                }
            }
            
            if (cars.length === 0) {
                return false; 
            }
            
            resultsTitle.style.display = 'block'; 
            let titleText = title.fccId ? `FCC ID: ${title.fccId}` : `P/N: ${title.partNumber}`;
            if (title.fccId && title.partNumber) {
                titleText = `FCC ID: ${title.fccId} | P/N: ${title.partNumber}`;
            }
            
            resultData.cars = cars;
            
            let carsHtml = cars.map(car => `
                <div class="alternative-card space-y-2 mb-3">
                    <div class="flex justify-between items-center">
                        <strong class="text-gray-400">الطراز:</strong>
                        <span class="font-semibold">${car.model}</span>
                    </div>
                    <div class="flex justify-between items-center">
                        <strong class="text-gray-400">السنوات:</strong>
                        <span class="latin-font">${car.years}</span>
                    </div>
                    <div>
                        <strong class="text-gray-400">ملاحظات:</strong>
                        <p class="text-sm text-gray-300 leading-relaxed mt-1">${car.notes}</p>
                    </div>
                </div>
            `).join('');
            
            const mainResultsHtml = `
                <div class="accordion-header active" onclick="toggleAccordion(this)">
                    <h3 class="font-bold text-lg text-white">السيارات المتوافقة مع (${titleText})</h3>
                    
                    <div class="accordion-actions">
                         <!-- [إزالة] زر الحفظ -->
                        <button class="action-btn" title="مشاركة النتيجة" onclick="shareResult(${JSON.stringify(resultData).replace(/"/g, "'")})">
                             <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" class="w-5 h-5">
                                <path stroke-linecap="round" stroke-linejoin="round" d="M7.217 10.907a2.25 2.25 0 1 0 0 2.186m0-2.186c.19.02.38.05.57.09m0 0c2.083.36 3.997.96 5.681 1.94m0 0c.16.1.31.2.46.3m0 0a2.25 2.25 0 1 0 0-2.186m0 2.186c-.19-.02-.38-.05-.57-.09m0 0c-2.083-.36-3.997-.96-5.681-1.94m0 0c-.16-.1-.31-.2-.46-.3m0 0a2.25 2.25 0 1 0 0 2.186m0-2.186-.57.09" />
                            </svg>
                        </button>
                    </div>

                    <svg class="accordion-icon w-5 h-5 text-gray-400" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7"></path></svg>
                </div>
                <div class="accordion-content active">
                    <div class="p-4 border border-gray-700 rounded-lg scrollable-card-container">
                        ${carsHtml}
                    </div>
                </div>
            `;
            resultBox.innerHTML = mainResultsHtml;
            return true;
        }
        
        // --- دوال مساعدة (نسخ، رسائل، إعادة محاولة) ---
        
        function copyToClipboard(text, iconElement) {
           if (!text || text === 'غير متوفر' || text === 'N/A') return;
           
           const originalPath = iconElement.innerHTML;
           const checkMarkPath = '<path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7"></path>';

           const showFeedback = () => {
               showMessage('تم النسخ: ' + text, 'info');
               iconElement.innerHTML = checkMarkPath;
               iconElement.classList.add('copied');
               
               setTimeout(() => {
                   iconElement.innerHTML = originalPath;
                   iconElement.classList.remove('copied');
               }, 2000);
           };

           if (navigator.clipboard && navigator.clipboard.writeText) {
               navigator.clipboard.writeText(text).then(showFeedback).catch(err => {
                   console.error('Failed to copy with Clipboard API: ', err);
                   fallbackCopyText(text, showFeedback);
               });
           } else {
               fallbackCopyText(text, showFeedback);
           }
        }

        function fallbackCopyText(text, successCallback) {
           const el = document.createElement('textarea');
           el.value = text;
           el.style.position = 'absolute';
           el.style.left = '-9999px';
           document.body.appendChild(el);
           el.select();
           try {
             document.execCommand('copy');
             successCallback();
           } catch (err) {
             console.error('Failed to copy text: ', err);
             showMessage('فشل النسخ', 'error');
           }
           document.body.removeChild(el);
        }

        function toggleAccordion(header) {
            if (event.target.closest('.action-btn')) {
                event.stopPropagation();
                return;
            }
            header.classList.toggle('active');
            const content = header.nextElementSibling;
            if (content.classList.contains('active')) {
                content.classList.remove('active');
            } else {
                content.classList.add('active');
            }
        }

        function showMessage(message, type) {
            messageBox.textContent = message;
            messageBox.style.display = 'block';
            
            if (type === 'success') {
                messageBox.style.backgroundColor = 'var(--success-color)';
            } else if (type === 'error') {
                messageBox.style.backgroundColor = 'var(--error-color)';
            } else if (type === 'info') {
                messageBox.style.backgroundColor = 'var(--info-color)';
            }
            messageBox.style.color = 'white';
            
            // جعل الرسائل الأطول تبقى لمدة أطول
            const duration = Math.max(3000, message.length * 100); 
            setTimeout(() => {
                messageBox.style.display = 'none';
            }, duration);
        }

        async function fetchWithRetry(url, options, maxRetries = 3, initialDelay = 1000) {
            let delay = initialDelay;
            for (let i = 0; i < maxRetries; i++) {
                try {
                    const response = await fetch(url, options);
                    if (response.ok) {
                        return response.json();
                    }
                    if (response.status === 429 || response.status >= 500) {
                        // أخطاء الخادم أو تجاوز الحد، أعد المحاولة
                        await new Promise(res => setTimeout(res, delay));
                        delay *= 2; 
                    } else {
                        // أخطاء العميل (مثل 400، 401)، لا تعد المحاولة
                        const errorData = await response.json();
                        throw new Error(`Client Error: ${response.status} - ${errorData.error.message || 'Unknown error'}`);
                    }
                } catch (error) {
                    // أخطاء الشبكة، أعد المحاولة
                    if (i === maxRetries - 1) throw error; // Re-throw last error
                    await new Promise(res => setTimeout(res, delay));
                    delay *= 2;
                }
            }
            throw new Error("فشل الاتصال بالـ API بعد عدة محاولات.");
        }
        
        // --- دوال الاقتراحات (Autocomplete) ---
        async function fetchCSV(url) {
            try {
                const response = await fetch(url);
                if (!response.ok) {
                    throw new Error(`Failed to fetch CSV: ${response.statusText}`);
                }
                const text = await response.text();
                return text.split('\n')
                           .map(item => item.trim())
                           .filter(item => item.length > 0);
            } catch (error) {
                console.error(`Error loading CSV from ${url}:`, error);
                return [];
            }
        }
        
        function showSuggestions(value, list, container, inputElement) {
            container.innerHTML = '';
            if (value.length === 0) {
                container.style.display = 'none';
                return;
            }
            const filtered = list.filter(item => 
                item.toLowerCase().startsWith(value.toLowerCase())
            );
            if (filtered.length > 0) {
                filtered.forEach(item => {
                    const div = document.createElement('div');
                    div.className = 'suggestion-item';
                    div.textContent = item;
                    div.addEventListener('click', () => {
                        inputElement.value = item;
                        container.style.display = 'none';
                    });
                    container.appendChild(div);
                });
                container.style.display = 'block';
            } else {
                container.style.display = 'none';
            }
        }
        
        // --- دوال سجل البحث ---
        function loadHistory() {
            const history = JSON.parse(localStorage.getItem('searchHistory') || '[]');
            historyBox.innerHTML = '';
            if (history.length > 0) {
                historyContainer.style.display = 'block';
                history.forEach(item => {
                    const div = document.createElement('div');
                    div.className = 'history-item';
                    div.innerHTML = `
                        <span class="latin-font">${item.title}</span>
                        <span class="history-type">${item.typeDisplay}</span>
                    `;
                    div.onclick = () => {
                        populateFormFromHistory(item);
                        form.requestSubmit(); 
                    };
                    historyBox.appendChild(div);
                });
            } else {
                historyContainer.style.display = 'none';
            }
        }

        function saveToHistory(searchData) {
            let history = JSON.parse(localStorage.getItem('searchHistory') || '[]');
            history = history.filter(item => item.id !== searchData.id);
            history.unshift(searchData);
            if (history.length > MAX_HISTORY) {
                history = history.slice(0, MAX_HISTORY);
            }
            localStorage.setItem('searchHistory', JSON.stringify(history));
            loadHistory();
        }

        function populateFormFromHistory(item) {
            document.getElementById(item.tabId).click();
            
            if (item.mode === 'specs') {
                document.getElementById('year').value = item.data.year;
                typeInput.value = item.data.type;
                modelInput.value = item.data.model;
                document.getElementById('market').value = item.data.market;
            } else if (item.mode === 'reverse') {
                document.getElementById('fcc_input').value = item.data.fccId;
                document.getElementById('pn_input').value = item.data.partNumber;
            } else if (item.mode === 'vin') {
                vinInput.value = item.data.vin;
                updateVinCounter(item.data.vin.length);
            }
        }
        
        // --- [جديد] دالة المشاركة ---
        async function shareResult(resultData) {
            let text = `*نتائج بحث MASTER KEY*\n\n`;
            text += `*البحث:* ${resultData.title}\n`;
            text += `*النوع:* ${resultData.type === 'specs' ? 'مواصفات' : 'بحث عكسي'}\n\n`;

            if (resultData.type === 'specs') {
                text += `*FCC ID:* ${resultData.fccId || 'N/A'}\n`;
                text += `*Part Number:* ${resultData.partNumber || 'N/A'}\n`;
                text += `*نصل المفتاح:* ${resultData.keyBlade || 'N/A'}\n`;
                text += `*نوع الريموت:* ${resultData.remoteType || 'N/A'}\n`;
            } else if (resultData.type === 'reverse' && resultData.cars) {
                text += "*السيارات المتوافقة:*\n";
                resultData.cars.forEach((car, index) => {
                    text += `${index + 1}. ${car.model} (${car.years})\n`;
                });
            }

            try {
                if (navigator.share) {
                    await navigator.share({
                        title: 'نتائج بحث MASTER KEY',
                        text: text,
                    });
                } else {
                    throw new Error('Web Share API not supported');
                }
            } catch (err) {
                fallbackCopyText(text, () => {
                     showMessage('تم نسخ ملخص النتيجة للحافظة', 'info');
                });
            }
        }

        // --- [جديد] تحديث عداد VIN ---
        function updateVinCounter(length) {
            vinCounter.textContent = `(${length}/17)`;
            if (length === 17 && VIN_REGEX.test(vinInput.value)) {
                vinCounter.classList.add('valid');
            } else {
                vinCounter.classList.remove('valid');
            }
        }
        
        // --- تشغيل عند تحميل الصفحة ---
        document.addEventListener('DOMContentLoaded', async () => {
            
            // --- [إزالة] تم حذف منطق قفل الحماية ---


            // --- الكود الأصلي لتحميل الصفحة ---
            carMakes = await fetchCSV(carMakesUrl);
            carModels = await fetchCSV(carModelsUrl);
            
            loadHistory();
            
            clearHistoryBtn.addEventListener('click', () => {
                localStorage.removeItem('searchHistory');
                loadHistory();
            });
            
            vinInput.addEventListener('input', (e) => {
                const vin = e.target.value.toUpperCase();
                e.target.value = vin; 
                updateVinCounter(vin.length);
            });
            
            typeInput.addEventListener('input', () => {
                showSuggestions(typeInput.value, carMakes, typeSuggestions, typeInput);
            });
            
            modelInput.addEventListener('input', () => {
                showSuggestions(modelInput.value, carModels, modelSuggestions, modelInput);
            });
            
            document.addEventListener('click', (e) => {
                if (!typeInput.contains(e.target) && !typeSuggestions.contains(e.target)) {
                    typeSuggestions.style.display = 'none';
                }
                if (!modelInput.contains(e.target) && !modelSuggestions.contains(e.target)) {
                    modelSuggestions.style.display = 'none';
                }
            });

            // --- [إزالة] تم حذف كل أكواد الـ PWA وتسجيل الـ Service Worker ---

        });

    </script>

</body>
</html>



